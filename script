local Players = game:GetService("Players")
local player = Players.LocalPlayer
local uis = game:GetService("UserInputService")
local rs = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local camera = workspace.CurrentCamera

local state = {
    ESP_Enabled = false,
    ESP_Box = false,
    ESP_Name = false,
    ESP_Skeleton = false,

    Noclip = false,
    InfJump = false,
    Fly = false,

    HomePos = nil,
}

local function tweenColor(button, enabled)
    TweenService:Create(button, TweenInfo.new(0.25), {
        BackgroundColor3 = enabled and Color3.fromRGB(50, 200, 100) or Color3.fromRGB(200, 50, 50)
    }):Play()
end

local function createToggle(parent, label, key, y)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -20, 0, 32)
    btn.Position = UDim2.new(0, 10, 0, y)
    btn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    btn.Font = Enum.Font.GothamMedium
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Text = label .. ": OFF"
    btn.AutoButtonColor = false
    local corner = Instance.new("UICorner", btn)
    corner.CornerRadius = UDim.new(0, 6)

    btn.MouseButton1Click:Connect(function()
        state[key] = not state[key]
        btn.Text = label .. ": " .. (state[key] and "ON" or "OFF")
        tweenColor(btn, state[key])
    end)

    btn.Parent = parent
    return btn
end

local function createGui()
    if player:FindFirstChild("PlayerGui") then
        local old = player.PlayerGui:FindFirstChild("mellontyX1_GUI")
        if old then old:Destroy() end
    end

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "mellontyX1_GUI"
    ScreenGui.IgnoreGuiInset = true
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = player:WaitForChild("PlayerGui")

    -- –ò–∫–æ–Ω–∫–∞
    local Icon = Instance.new("ImageButton", ScreenGui)
    Icon.Name = "OpenMenu"
    Icon.Size = UDim2.new(0, 60, 0, 60)
    Icon.Position = UDim2.new(0, 20, 0.5, -30)
    Icon.BackgroundTransparency = 1
    Icon.Image = "rbxassetid://15276188648"
    Icon.ZIndex = 5

    -- –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏
    local dragging, dragInput, dragStart, startPos
    Icon.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = Icon.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    Icon.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    uis.InputChanged:Connect(function(input)
        if dragging and input == dragInput then
            local delta = input.Position - dragStart
            Icon.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)

    -- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    local Frame = Instance.new("Frame", ScreenGui)
    Frame.Name = "MainFrame"
    Frame.Size = UDim2.new(0, 380, 0, 400)
    Frame.Position = UDim2.new(0.5, -190, 0.5, -200)
    Frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    Frame.Visible = false
    Frame.Active = true
    Frame.Draggable = true
    Frame.BorderSizePixel = 0
    Frame.ClipsDescendants = true
    Frame.AnchorPoint = Vector2.new(0.5, 0.5)
    Frame.ZIndex = 4

    local UICorner = Instance.new("UICorner", Frame)
    UICorner.CornerRadius = UDim.new(0, 20)

    -- –ó–∞–≥–æ–ª–æ–≤–æ–∫
    local Title = Instance.new("TextLabel", Frame)
    Title.Size = UDim2.new(1, 0, 0, 45)
    Title.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    Title.Text = "üí† by mellontyX1"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.TextSize = 22
    Title.Font = Enum.Font.GothamBold
    Title.BorderSizePixel = 0
    Title.AnchorPoint = Vector2.new(0, 0)
    Title.Position = UDim2.new(0, 0, 0, 0)
    local titleCorner = Instance.new("UICorner", Title)
    titleCorner.CornerRadius = UDim.new(0, 20)

    -- –í–∫–ª–∞–¥–∫–∏
    local TabsFrame = Instance.new("Frame", Frame)
    TabsFrame.Size = UDim2.new(1, 0, 0, 40)
    TabsFrame.Position = UDim2.new(0, 0, 0, 45)
    TabsFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    local tabsCorner = Instance.new("UICorner", TabsFrame)
    tabsCorner.CornerRadius = UDim.new(0, 15)

    local TabContent = Instance.new("Frame", Frame)
    TabContent.Position = UDim2.new(0, 0, 0, 90)
    TabContent.Size = UDim2.new(1, 0, 1, -90)
    TabContent.BackgroundTransparency = 1

    local tabs = {"Visual", "Game", "Setting"}
    local tabFrames = {}

    for i, tabName in ipairs(tabs) do
        local Button = Instance.new("TextButton", TabsFrame)
        Button.Size = UDim2.new(0, 110, 0, 30)
        Button.Position = UDim2.new(0, (i - 1) * 120 + 10, 0, 5)
        Button.Text = tabName
        Button.Font = Enum.Font.GothamBold
        Button.TextColor3 = Color3.fromRGB(255, 255, 255)
        Button.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
        Button.AutoButtonColor = false
        local bc = Instance.new("UICorner", Button)
        bc.CornerRadius = UDim.new(0, 12)

        local Tab = Instance.new("Frame", TabContent)
        Tab.Size = UDim2.new(1, 0, 1, 0)
        Tab.BackgroundTransparency = 1
        Tab.Visible = i == 1
        tabFrames[tabName] = Tab

        Button.MouseButton1Click:Connect(function()
            for _, f in pairs(tabFrames) do f.Visible = false end
            Tab.Visible = true
        end)
    end

    -- === Visual Tab Content ===
    local visualTab = tabFrames["Visual"]
    createToggle(visualTab, "ESP", "ESP_Enabled", 10).Parent = visualTab
    createToggle(visualTab, "ESP Box", "ESP_Box", 60).Parent = visualTab
    createToggle(visualTab, "ESP Name", "ESP_Name", 110).Parent = visualTab
    createToggle(visualTab, "ESP Skeleton", "ESP_Skeleton", 160).Parent = visualTab

    -- === Game Tab Content ===
    local gameTab = tabFrames["Game"]

    local function createButton(parent, text, y)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(1, -20, 0, 40)
        btn.Position = UDim2.new(0, 10, 0, y)
        btn.Text = text
        btn.Font = Enum.Font.GothamBold
        btn.TextColor3 = Color3.new(1,1,1)
        btn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
        local corner = Instance.new("UICorner", btn)
        corner.CornerRadius = UDim.new(0, 12)
        btn.Parent = parent
        return btn
    end

    local setHomeBtn = createButton(gameTab, "Set Home", 10)
    local tpHomeBtn = createButton(gameTab, "TP Home", 60)

    local noclipBtn = createToggle(gameTab, "Noclip", "Noclip", 110)
    local infJumpBtn = createToggle(gameTab, "Inf Jump", "InfJump", 160)
    local flyBtn = createToggle(gameTab, "Fly", "Fly", 210)

    -- === Setting Tab Content ===
    local settingTab = tabFrames["Setting"]
    local infoLabel = Instance.new("TextLabel", settingTab)
    infoLabel.Size = UDim2.new(1, 0, 0, 40)
    infoLabel.Position = UDim2.new(0, 0, 0, 10)
    infoLabel.BackgroundTransparency = 1
    infoLabel.Text = "by mellontyX1"
    infoLabel.Font = Enum.Font.GothamBold
    infoLabel.TextColor3 = Color3.new(1,1,1)
    infoLabel.TextSize = 24

    -- –ö–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏ (–∑–∞–≥–ª—É—à–∫–∏)
    local saveBtn = createButton(settingTab, "Save Config", 70)
    local loadBtn = createButton(settingTab, "Load Config", 130)

    saveBtn.MouseButton1Click:Connect(function()
        local json = HttpService:JSONEncode(state)
        print("Config saved: "..json)
    end)
    loadBtn.MouseButton1Click:Connect(function()
        print("Load config is not implemented.")
    end)

    -- –û—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é
    Icon.MouseButton1Click:Connect(function()
        Frame.Visible = not Frame.Visible
    end)

    -- ====== ESP Implementation ======

    local drawings = {}

    local function createESP(plr)
        if drawings[plr] then return end
        local box = Drawing.new("Square")
        box.Color = Color3.fromRGB(255, 50, 50)
        box.Thickness = 2
        box.Filled = false
        box.Visible = false

        local nameTag = Drawing.new("Text")
        nameTag.Text = plr.Name
        nameTag.Color = Color3.new(1,1,1)
        nameTag.Size = 14
        nameTag.Center = true
        nameTag.Outline = true
        nameTag.Visible = false

        local lines = {}
        for i = 1, 5 do
            local line = Drawing.new("Line")
            line.Color = Color3.fromRGB(0, 255, 255)
            line.Thickness = 1
            line.Visible = false
            table.insert(lines, line)
        end

        drawings[plr] = {
            Box = box,
            Name = nameTag,
            Lines = lines,
        }
    end

    local function removeESP(plr)
        if drawings[plr] then
            drawings[plr].Box.Visible = false
            drawings[plr].Name.Visible = false
            for _, l in pairs(drawings[plr].Lines) do
                l.Visible = false
            end
            drawings[plr] = nil
        end
    end

    rs.RenderStepped:Connect(function()
        if not state.ESP_Enabled then
            for plr, drawData in pairs(drawings) do
                drawData.Box.Visible = false
                drawData.Name.Visible = false
                for _, line in pairs(drawData.Lines) do
                    line.Visible = false
                end
            end
            return
        end

        for _, plr2 in pairs(Players:GetPlayers()) do
            if plr2 ~= player and plr2.Character and plr2.Character:FindFirstChild("HumanoidRootPart") and plr2.Character:FindFirstChild("Humanoid") and plr2.Character.Humanoid.Health > 0 then
                createESP(plr2)
                local hrp = plr2.Character.HumanoidRootPart
                local pos, onScreen = camera:WorldToViewportPoint(hrp.Position)
                if onScreen then
                    local size = Vector2.new(35, 70)

                    local box = drawings[plr2].Box
                    box.Position = Vector2.new(pos.X - size.X/2, pos.Y - size.Y/2)
                    box.Size = size
                    box.Visible = state.ESP_Box

                    local nameTag = drawings[plr2].Name
                    nameTag.Position = Vector2.new(pos.X, pos.Y - size.Y/2 - 15)
                    nameTag.Text = plr2.Name
                    nameTag.Visible = state.ESP_Name

                    local lines = drawings[plr2].Lines
                    if state.ESP_Skeleton then
                        local head = plr2.Character:FindFirstChild("Head")
                        if head then
                            local headPos, headOn = camera:WorldToViewportPoint(head.Position)
                            if headOn then
                                lines[1].From = Vector2.new(pos.X, pos.Y)
                                lines[1].To = Vector2.new(headPos.X, headPos.Y)
                                lines[1].Visible = true
                            else
                                lines[1].Visible = false
                            end
                        else
                            lines[1].Visible = false
                        end
                        for i=2,5 do
                            lines[i].Visible = false
                        end
                    else
                        for i=1,5 do
                            lines[i].Visible = false
                        end
                    end
                else
                    removeESP(plr2)
                end
            else
                removeESP(plr2)
            end
        end
    end)

    -- ===== Game Logic =====

    local function noclipLoop()
        while state.Noclip do
            task.wait()
            local char = player.Character
            if char then
                for _, part in pairs(char:GetChildren()) do
                    if part:IsA("BasePart") and part.CanCollide then
                        part.CanCollide = false
                    end
                end
            end
        end
    end

    local function onJumpRequest()
        if state.InfJump then
            local humanoid = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
            if humanoid and humanoid:GetState() ~= Enum.HumanoidStateType.Freefall then
                humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
            end
        end
    end

    -- Set Home
    setHomeBtn.MouseButton1Click:Connect(function()
        local char = player.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            state.HomePos = char.HumanoidRootPart.Position
            setHomeBtn.Text = "Home Set"
            tweenColor(setHomeBtn, true)
            task.delay(2, function()
                setHomeBtn.Text = "Set Home"
                tweenColor(setHomeBtn, false)
            end)
        end
    end)

    -- TP Home
    tpHomeBtn.MouseButton1Click:Connect(function()
        local char = player.Character
        if char and char:FindFirstChild("HumanoidRootPart") and state.HomePos then
            local hrp = char.HumanoidRootPart
            local oldPos = hrp.Position
            hrp.CFrame = CFrame.new(state.HomePos)
            task.wait(0.05)
            hrp.CFrame = CFrame.new(oldPos)
        end
    end)

    noclipBtn.MouseButton1Click:Connect(function()
        state.Noclip = not state.Noclip
        tweenColor(noclipBtn, state.Noclip)
        if state.Noclip then
            task.spawn(noclipLoop)
        end
    end)

    infJumpBtn.MouseButton1Click:Connect(function()
        state.InfJump = not state.InfJump
        tweenColor(infJumpBtn, state.InfJump)
    end)
    game:GetService("UserInputService").JumpRequest:Connect(onJumpRequest)

    local flySpeed = 50
    local flying = false
    local bodyVelocity

    local function startFly()
        local char = player.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            bodyVelocity = Instance.new("BodyVelocity")
            bodyVelocity.Velocity = Vector3.new(0,0,0)
            bodyVelocity.MaxForce = Vector3.new(1e5,1e5,1e5)
            bodyVelocity.Parent = char.HumanoidRootPart
            flying = true
        end
    end
    local function stopFly()
        if bodyVelocity then
            bodyVelocity:Destroy()
            bodyVelocity = nil
        end
        flying = false
    end

    flyBtn.MouseButton1Click:Connect(function()
        state.Fly = not state.Fly
        tweenColor(flyBtn, state.Fly)
        if state.Fly then
            startFly()
        else
            stopFly()
        end
    end)

    rs.RenderStepped:Connect(function()
        if flying and bodyVelocity then
            local camCF = workspace.CurrentCamera.CFrame
            local moveDir = Vector3.new(0,0,0)
            if uis:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + camCF.LookVector end
            if uis:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - camCF.LookVector end
            if uis:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - camCF.RightVector end
            if uis:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + camCF.RightVector end
            if uis:IsKeyDown(Enum.KeyCode.Space) then moveDir = moveDir + Vector3.new(0,1,0) end
            if uis:IsKeyDown(Enum.KeyCode.LeftControl) then moveDir = moveDir - Vector3.new(0,1,0) end

            if moveDir.Magnitude > 0 then
                moveDir = moveDir.Unit * flySpeed
                bodyVelocity.Velocity = moveDir
            else
                bodyVelocity.Velocity = Vector3.new(0,0,0)
            end
        end
    end)

    return ScreenGui
end

local gui = createGui()

player.CharacterAdded:Connect(function()
    task.wait(1)
    if gui and gui.Parent == player.PlayerGui then return end
    gui = createGui()
end)
